<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>3D Virtual Try-On - SMART CART</title>
    
    <!-- Three.js for 3D rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    
    <!-- TensorFlow.js for body segmentation -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-segmentation"></script>
    
    <link href="http://127.0.0.1:5000/static/css/styles.css" rel="stylesheet" />
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }
        
        .container-3d {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
        }
        
        .video-panel {
            width: 50%;
            position: relative;
            background: #000;
        }
        
        .model-panel {
            width: 50%;
            position: relative;
            background: #1a1a1a;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        #threejs-container {
            width: 100%;
            height: 100%;
        }
        
        .controls-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 15px;
            color: white;
            min-width: 250px;
        }
        
        .controls-panel h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        
        .control-group {
            margin: 15px 0;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .control-group input, .control-group select {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .control-group button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .control-group button:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .control-group button.danger {
            background: #f44336;
        }
        
        .control-group button.danger:hover {
            background: #da190b;
        }
        
        .cloth-gallery {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 15px;
            display: flex;
            gap: 15px;
            max-width: 80%;
            overflow-x: auto;
        }
        
        .cloth-3d-item {
            width: 80px;
            height: 80px;
            border: 3px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .cloth-3d-item:hover {
            border-color: #4CAF50;
            transform: scale(1.1);
        }
        
        .cloth-3d-item.selected {
            border-color: #FFD700;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        
        .cloth-3d-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 7px;
        }
        
        .status-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 15px;
            color: white;
            min-width: 200px;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-dot.active {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        
        .status-dot.inactive {
            background: #f44336;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .loading-3d {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }
        
        .spinner-3d {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container-3d">
        <!-- Video Panel -->
        <div class="video-panel">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="canvas"></canvas>
        </div>
        
        <!-- 3D Model Panel -->
        <div class="model-panel">
            <div id="threejs-container"></div>
        </div>
        
        <!-- Controls Panel -->
        <div class="controls-panel">
            <h3>3D Try-On Controls</h3>
            
            <div class="control-group">
                <button id="startCamera" onclick="startCamera()">Start Camera</button>
                <button id="stopCamera" onclick="stopCamera()" class="danger">Stop Camera</button>
            </div>
            
            <div class="control-group">
                <label>Body Model</label>
                <select id="bodyModel" onchange="changeBodyModel()">
                    <option value="default">Default Avatar</option>
                    <option value="male">Male Model</option>
                    <option value="female">Female Model</option>
                    <option value="custom">Custom from Camera</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Lighting</label>
                <input type="range" id="lightIntensity" min="0" max="2" step="0.1" value="1" onchange="updateLighting()">
            </div>
            
            <div class="control-group">
                <label>Model Rotation</label>
                <input type="range" id="modelRotation" min="0" max="360" step="1" value="0" onchange="rotateModel()">
            </div>
            
            <div class="control-group">
                <button onclick="resetView()">Reset View</button>
                <button onclick="captureScreenshot()">Capture</button>
                <button onclick="toggleFullscreen()">Fullscreen</button>
            </div>
            
            <div class="control-group">
                <button onclick="goBack()" class="danger">Back to Home</button>
            </div>
        </div>
        
        <!-- Status Panel -->
        <div class="status-panel">
            <h4>System Status</h4>
            <div class="status-indicator">
                <div class="status-dot inactive" id="cameraStatus"></div>
                <span>Camera</span>
            </div>
            <div class="status-indicator">
                <div class="status-dot inactive" id="modelStatus"></div>
                <span>3D Model</span>
            </div>
            <div class="status-indicator">
                <div class="status-dot inactive" id="trackingStatus"></div>
                <span>Body Tracking</span>
            </div>
            <div id="performanceInfo">
                <p>FPS: <span id="fps">0</span></p>
                <p>Triangles: <span id="triangles">0</span></p>
            </div>
        </div>
        
        <!-- Cloth Gallery -->
        <div class="cloth-gallery" id="clothGallery">
            <!-- Will be populated dynamically -->
        </div>
        
        <!-- Loading Indicator -->
        <div id="loading3d" class="loading-3d" style="display: none;">
            <div class="spinner-3d"></div>
            <h3>Loading 3D Environment...</h3>
            <p>Please wait while we initialize the 3D try-on system</p>
        </div>
    </div>

    <script>
        // Global variables
        let scene, camera3d, renderer, controls;
        let video, canvas, ctx;
        let currentStream = null;
        let bodySegmentation = null;
        let avatarModel = null;
        let selectedClothing = null;
        let animationId = null;
        let stats = { fps: 0, triangles: 0 };
        
        // Initialize 3D environment
        async function init3D() {
            showLoading(true);
            
            try {
                // Initialize Three.js scene
                initThreeJS();
                
                // Initialize camera and canvas
                initCamera();
                
                // Load body segmentation model
                await initBodySegmentation();
                
                // Load default avatar
                await loadAvatar('default');
                
                // Load clothing options
                loadClothingGallery();
                
                // Start render loop
                animate();
                
                updateStatus('modelStatus', true);
                showLoading(false);
                
            } catch (error) {
                console.error('Error initializing 3D environment:', error);
                alert('Failed to initialize 3D environment. Please refresh and try again.');
            }
        }
        
        // Initialize Three.js scene
        function initThreeJS() {
            const container = document.getElementById('threejs-container');
            
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);
            
            // Camera
            camera3d = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera3d.position.set(0, 1.6, 3);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);
            
            // Controls
            controls = new THREE.OrbitControls(camera3d, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.target.set(0, 1, 0);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 10, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // Floor
            const floorGeometry = new THREE.PlaneGeometry(10, 10);
            const floorMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
        }
        
        // Initialize camera
        function initCamera() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
        }
        
        // Initialize body segmentation
        async function initBodySegmentation() {
            try {
                bodySegmentation = await bodySegmentation.createSegmenter(
                    bodySegmentation.SupportedModels.MediaPipeSelfieSegmentation,
                    { runtime: 'tfjs' }
                );
            } catch (error) {
                console.warn('Body segmentation not available:', error);
            }
        }
        
        // Load avatar model
        async function loadAvatar(type) {
            // Remove existing avatar
            if (avatarModel) {
                scene.remove(avatarModel);
            }
            
            // Create basic avatar geometry
            const avatarGroup = new THREE.Group();
            
            // Body
            const bodyGeometry = new THREE.CylinderGeometry(0.3, 0.4, 1.5, 8);
            const bodyMaterial = new THREE.MeshLambertMaterial({ color: 0xfdbcb4 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 1;
            body.castShadow = true;
            avatarGroup.add(body);
            
            // Head
            const headGeometry = new THREE.SphereGeometry(0.2, 8, 8);
            const headMaterial = new THREE.MeshLambertMaterial({ color: 0xfdbcb4 });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 1.9;
            head.castShadow = true;
            avatarGroup.add(head);
            
            // Arms
            const armGeometry = new THREE.CylinderGeometry(0.08, 0.1, 0.8, 6);
            const armMaterial = new THREE.MeshLambertMaterial({ color: 0xfdbcb4 });
            
            const leftArm = new THREE.Mesh(armGeometry, armMaterial);
            leftArm.position.set(-0.5, 1.2, 0);
            leftArm.rotation.z = Math.PI / 6;
            leftArm.castShadow = true;
            avatarGroup.add(leftArm);
            
            const rightArm = new THREE.Mesh(armGeometry, armMaterial);
            rightArm.position.set(0.5, 1.2, 0);
            rightArm.rotation.z = -Math.PI / 6;
            rightArm.castShadow = true;
            avatarGroup.add(rightArm);
            
            // Legs
            const legGeometry = new THREE.CylinderGeometry(0.1, 0.12, 0.8, 6);
            const legMaterial = new THREE.MeshLambertMaterial({ color: 0xfdbcb4 });
            
            const leftLeg = new THREE.Mesh(legGeometry, legMaterial);
            leftLeg.position.set(-0.15, 0.1, 0);
            leftLeg.castShadow = true;
            avatarGroup.add(leftLeg);
            
            const rightLeg = new THREE.Mesh(legGeometry, legMaterial);
            rightLeg.position.set(0.15, 0.1, 0);
            rightLeg.castShadow = true;
            avatarGroup.add(rightLeg);
            
            avatarModel = avatarGroup;
            scene.add(avatarModel);
            
            stats.triangles = calculateTriangles();
        }
        
        // Load clothing gallery
        function loadClothingGallery() {
            const gallery = document.getElementById('clothGallery');
            
            const clothingItems = [
                { id: 1, name: 'T-Shirt', image: '/static/data/tshirt.jpg', type: 'top' },
                { id: 2, name: 'Dress', image: '/static/data/dress.jpg', type: 'dress' },
                { id: 3, name: 'Jacket', image: '/static/data/jacket.jpg', type: 'top' },
                { id: 4, name: 'Jeans', image: '/static/data/jeans.jpg', type: 'bottom' },
                { id: 5, name: 'Skirt', image: '/static/data/skirt.jpg', type: 'bottom' }
            ];
            
            gallery.innerHTML = '';
            
            clothingItems.forEach(item => {
                const clothDiv = document.createElement('div');
                clothDiv.className = 'cloth-3d-item';
                clothDiv.onclick = () => selectClothing(item, clothDiv);
                
                const img = document.createElement('img');
                img.src = item.image;
                img.alt = item.name;
                img.onerror = () => {
                    // Fallback image
                    img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjNENBRjUwIi8+CjxwYXRoIGQ9Ik0yMCAyMEg2MFY2MEgyMFYyMFoiIGZpbGw9IiNGRkZGRkYiLz4KPC9zdmc+';
                };
                
                clothDiv.appendChild(img);
                gallery.appendChild(clothDiv);
            });
        }
        
        // Select clothing item
        function selectClothing(item, element) {
            // Remove previous selection
            document.querySelectorAll('.cloth-3d-item').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Select new item
            element.classList.add('selected');
            selectedClothing = item;
            
            // Apply clothing to avatar
            applyClothingToAvatar(item);
        }
        
        // Apply clothing to avatar
        function applyClothingToAvatar(clothing) {
            if (!avatarModel) return;
            
            // Remove existing clothing
            const existingClothing = avatarModel.children.filter(child => child.userData.isClothing);
            existingClothing.forEach(cloth => avatarModel.remove(cloth));
            
            // Create clothing geometry based on type
            let clothingMesh;
            
            switch (clothing.type) {
                case 'top':
                    const topGeometry = new THREE.CylinderGeometry(0.32, 0.42, 0.8, 8);
                    const topMaterial = new THREE.MeshLambertMaterial({ 
                        color: getRandomColor(),
                        transparent: true,
                        opacity: 0.9
                    });
                    clothingMesh = new THREE.Mesh(topGeometry, topMaterial);
                    clothingMesh.position.y = 1.2;
                    break;
                    
                case 'bottom':
                    const bottomGeometry = new THREE.CylinderGeometry(0.42, 0.35, 0.6, 8);
                    const bottomMaterial = new THREE.MeshLambertMaterial({ 
                        color: getRandomColor(),
                        transparent: true,
                        opacity: 0.9
                    });
                    clothingMesh = new THREE.Mesh(bottomGeometry, bottomMaterial);
                    clothingMesh.position.y = 0.5;
                    break;
                    
                case 'dress':
                    const dressGeometry = new THREE.CylinderGeometry(0.32, 0.5, 1.4, 8);
                    const dressMaterial = new THREE.MeshLambertMaterial({ 
                        color: getRandomColor(),
                        transparent: true,
                        opacity: 0.9
                    });
                    clothingMesh = new THREE.Mesh(dressGeometry, dressMaterial);
                    clothingMesh.position.y = 0.9;
                    break;
            }
            
            if (clothingMesh) {
                clothingMesh.userData.isClothing = true;
                clothingMesh.castShadow = true;
                avatarModel.add(clothingMesh);
            }
        }
        
        // Start camera
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    }
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                
                canvas.width = video.videoWidth || 640;
                canvas.height = video.videoHeight || 480;
                
                updateStatus('cameraStatus', true);
                
                // Start body tracking
                if (bodySegmentation) {
                    startBodyTracking();
                }
                
            } catch (error) {
                console.error('Error starting camera:', error);
                alert('Failed to start camera. Please check permissions.');
            }
        }
        
        // Stop camera
        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            updateStatus('cameraStatus', false);
            updateStatus('trackingStatus', false);
        }
        
        // Start body tracking
        async function startBodyTracking() {
            if (!bodySegmentation || !video) return;
            
            const processFrame = async () => {
                if (video.readyState === 4) {
                    try {
                        const segmentation = await bodySegmentation.segmentPeople(video);
                        
                        // Draw segmentation on canvas
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        
                        if (segmentation.length > 0) {
                            updateStatus('trackingStatus', true);
                            
                            // Apply body tracking to avatar
                            updateAvatarFromTracking(segmentation[0]);
                        } else {
                            updateStatus('trackingStatus', false);
                        }
                        
                    } catch (error) {
                        console.warn('Body tracking error:', error);
                    }
                }
                
                if (currentStream) {
                    requestAnimationFrame(processFrame);
                }
            };
            
            processFrame();
        }
        
        // Update avatar from body tracking
        function updateAvatarFromTracking(segmentation) {
            if (!avatarModel) return;
            
            // Simple body tracking - rotate avatar based on detected pose
            // This is a simplified implementation
            const rotation = Math.sin(Date.now() * 0.001) * 0.1;
            avatarModel.rotation.y = rotation;
        }
        
        // Animation loop
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // Update controls
            controls.update();
            
            // Update stats
            updateStats();
            
            // Render scene
            renderer.render(scene, camera3d);
        }
        
        // Update statistics
        function updateStats() {
            stats.fps = Math.round(1000 / 16.67); // Approximate FPS
            document.getElementById('fps').textContent = stats.fps;
            document.getElementById('triangles').textContent = stats.triangles;
        }
        
        // Calculate triangles in scene
        function calculateTriangles() {
            let triangles = 0;
            scene.traverse(child => {
                if (child.geometry) {
                    triangles += child.geometry.attributes.position.count / 3;
                }
            });
            return Math.round(triangles);
        }
        
        // Update status indicator
        function updateStatus(statusId, active) {
            const statusDot = document.getElementById(statusId);
            statusDot.className = `status-dot ${active ? 'active' : 'inactive'}`;
        }
        
        // Control functions
        function changeBodyModel() {
            const modelType = document.getElementById('bodyModel').value;
            loadAvatar(modelType);
        }
        
        function updateLighting() {
            const intensity = document.getElementById('lightIntensity').value;
            scene.children.forEach(child => {
                if (child.type === 'DirectionalLight') {
                    child.intensity = intensity;
                }
            });
        }
        
        function rotateModel() {
            const rotation = document.getElementById('modelRotation').value;
            if (avatarModel) {
                avatarModel.rotation.y = (rotation * Math.PI) / 180;
            }
        }
        
        function resetView() {
            controls.reset();
            if (avatarModel) {
                avatarModel.rotation.set(0, 0, 0);
            }
            document.getElementById('modelRotation').value = 0;
        }
        
        function captureScreenshot() {
            const link = document.createElement('a');
            link.download = `3d-tryon-${Date.now()}.png`;
            link.href = renderer.domElement.toDataURL();
            link.click();
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function goBack() {
            window.location.href = '/home';
        }
        
        // Utility functions
        function getRandomColor() {
            const colors = [0xff6b6b, 0x4ecdc4, 0x45b7d1, 0x96ceb4, 0xfeca57, 0xff9ff3, 0x54a0ff];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        function showLoading(show) {
            document.getElementById('loading3d').style.display = show ? 'block' : 'none';
        }
        
        function onWindowResize() {
            const container = document.getElementById('threejs-container');
            camera3d.aspect = container.clientWidth / container.clientHeight;
            camera3d.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }
        
        // Initialize when page loads
        window.addEventListener('load', init3D);
        
        // Cleanup when page unloads
        window.addEventListener('beforeunload', () => {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            stopCamera();
        });
    </script>
</body>
</html>